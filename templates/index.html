{% extends "base.html" %}

{% block title %}재무제표 시각화 - 홈{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8 text-center">
            <h1 class="display-4 fw-bold text-primary mb-4">
                <i class="fas fa-chart-line me-3"></i>
                재무제표 시각화
            </h1>
            <p class="lead text-muted mb-4">
                Open DART API를 활용하여 상장기업의 재무정보를 실시간으로 조회하고 시각화합니다.
            </p>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <h3 class="card-title text-center mb-4">
                        <i class="fas fa-search me-2"></i>
                        회사 검색
                    </h3>
                    
                    <!-- Search Form -->
                    <div class="mb-4">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-building"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="company-search" 
                                   placeholder="회사명을 입력하세요 (예: 삼성전자, SK하이닉스)"
                                   autocomplete="off">
                            <button class="btn btn-primary" type="button" id="search-btn">
                                <i class="fas fa-search me-1"></i>검색
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            회사명의 일부만 입력해도 검색됩니다.
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="d-none">
                        <h5 class="mb-3">
                            <i class="fas fa-list me-2"></i>
                            검색 결과
                        </h5>
                        <div id="results-container"></div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">검색 중...</span>
                        </div>
                        <p class="mt-2 text-muted">검색 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">주요 기능</h3>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-search fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title">빠른 회사 검색</h5>
                    <p class="card-text text-muted">
                        수만 개의 상장기업 데이터베이스에서 회사명으로 빠르게 검색할 수 있습니다.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-chart-bar fa-3x text-success"></i>
                    </div>
                    <h5 class="card-title">실시간 재무데이터</h5>
                    <p class="card-text text-muted">
                        Open DART에서 제공하는 최신 재무제표 정보를 실시간으로 조회합니다.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-chart-line fa-3x text-info"></i>
                    </div>
                    <h5 class="card-title">시각화 대시보드</h5>
                    <p class="card-text text-muted">
                        차트와 그래프로 재무정보를 직관적으로 시각화하여 제공합니다.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Status -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>안내:</strong> 
                이 서비스는 금융감독원 Open DART API를 사용합니다. 
                정확한 데이터 조회를 위해 API 키가 필요합니다.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('company-search');
    const searchBtn = document.getElementById('search-btn');
    const resultsContainer = document.getElementById('results-container');
    const searchResults = document.getElementById('search-results');
    const loading = document.getElementById('loading');

    // 검색 함수
    function searchCompanies() {
        const query = searchInput.value.trim();
        if (!query) {
            alert('회사명을 입력해주세요.');
            return;
        }

        // UI 상태 변경
        loading.classList.remove('d-none');
        searchResults.classList.add('d-none');
        resultsContainer.innerHTML = '';

        // API 호출
        fetch(`/api/search-companies?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                loading.classList.add('d-none');
                
                if (data.success) {
                    displayResults(data.companies);
                } else {
                    alert('검색 중 오류가 발생했습니다: ' + data.error);
                }
            })
            .catch(error => {
                loading.classList.add('d-none');
                alert('네트워크 오류가 발생했습니다.');
                console.error('Error:', error);
            });
    }

    // 결과 표시 함수
    function displayResults(companies) {
        if (companies.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    검색 결과가 없습니다. 다른 검색어를 시도해보세요.
                </div>
            `;
        } else {
            const resultHtml = companies.map(company => `
                <div class="card mb-2 company-card" style="cursor: pointer;" 
                     onclick="goToDashboard('${company.corp_code}')">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-building me-2 text-primary"></i>
                                    ${company.corp_name}
                                </h6>
                                ${company.corp_eng_name ? `<small class="text-muted">${company.corp_eng_name}</small>` : ''}
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">
                                    <i class="fas fa-code me-1"></i>
                                    회사코드: ${company.corp_code}
                                </small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">
                                    ${company.stock_code ? 
                                        `<i class="fas fa-chart-line me-1"></i>종목코드: ${company.stock_code}` : 
                                        '<i class="fas fa-minus me-1"></i>비상장'
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.innerHTML = resultHtml;
        }
        
        searchResults.classList.remove('d-none');
    }

    // 대시보드로 이동
    window.goToDashboard = function(corpCode) {
        window.location.href = `/dashboard/${corpCode}`;
    };

    // 이벤트 리스너
    searchBtn.addEventListener('click', searchCompanies);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchCompanies();
        }
    });

    // 실시간 검색 (optional)
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                searchCompanies();
            }, 500);
        }
    });
});
</script>
{% endblock %}
